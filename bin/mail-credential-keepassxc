#!/bin/sh

# A helper that provides nicer syntax to git-credential-keepassxc for use in
# scripts.

set -e
set -u

partition_and_run() (
	XDG_DATA_HOME="${XDG_DATA_HOME:-"${HOME}/.local/share"}"
	CARGO_HOME="${CARGO_HOME:-"${XDG_DATA_HOME}/cargo"}"
	PATH="${CARGO_HOME}/bin:${PATH}"

	args=''
	filter=''

	while [ "${#}" -gt 0 ]
	do
		case "${1}" in
			url=*|username=*)
				filter="${filter}${1}
"
				;;
			*)
				args="${args} ${1}"
				;;
		esac

		shift
	done

	# shellcheck disable=2086
	# Word splitting is the intended effect here.
	echo "${filter}"                          \
		| git-credential-keepassxc get ${args} \
		| sed -n 's/^password=//p'
)

partition_and_run "${@}"
